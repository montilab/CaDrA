test_that("CaDrA returns expected result for ks algorithm",{
  
  # Load pre-computed feature set
  data(sim_FS)
  
  # Load pre-computed input-score
  data(sim_Scores)
  
  set.seed(21)
  
  # ks_pval
  result <- CaDrA(
    FS = sim_FS, 
    input_score = sim_Scores, 
    method = "ks_pval", 
    weight = NULL, 
    alternative = "less", 
    top_N = 1,
    search_start = NULL, 
    search_method = "both", 
    max_size = 7, 
    n_perm = 10, 
    plot = FALSE, 
    smooth = TRUE, 
    obs_best_score = NULL,
    ncores = 1, 
    cache_path = NULL
  )
  
  
  testthat::expect_length(result, 4L)
  testthat::expect_type(result, "list")
  testthat::expect_named(result, 
            c("key","perm_best_scores","obs_best_score","perm_pval"))

  testthat::expect_type(result$key, "list")
  testthat::expect_length(result$key, 11L)
  testthat::expect_named(result$key, 
             c("FS", "input_score", "method", "custom_function", 
               "custom_parameters", "alternative", "weight", "top_N",
               "search_start", "search_method", "max_size"))
  testthat::expect_type(result$key$FS, "double")
  
  testthat::expect_equal(round(result$perm_best_scores[1:10],5), 
                         c("TN_981"=13.13674,
                           "TN_519"=16.10120,
                           "TN_490"=14.50847,
                           "TN_714"=16.05025,
                           "TN_164"=17.67213,
                           "TN_756"=15.41408,
                           "TN_536"=13.03759,
                           "TN_128"=15.91316,
                           "TN_923"=13.95864,
                           "TN_352"=14.60017))
 
  testthat::expect_equal(round(result$obs_best_score,5), c("TN_716"=14.90173))
  
  # A smooth factor of 1
  c <- 1
  
  #Add a smoothing factor of 1 
  #This is just to not return a p-value of 0
  testthat::expect_equal(
    round((sum(result$perm_best_scores[1:10] > result$obs_best_score)+c)/(10+c),7), 
    c(0.5454545)
  )
   
  set.seed(21)
  # ks_score
  result <- CaDrA(
    FS = sim_FS, 
    input_score = sim_Scores, 
    method = "ks_score", 
    weight = NULL, 
    alternative = "less", 
    top_N = 1,
    search_start = NULL, 
    search_method = "both", 
    max_size = 7, 
    n_perm = 10, 
    plot = FALSE, 
    smooth = TRUE, 
    obs_best_score = NULL,
    ncores = 1, 
    cache_path = NULL
  )
  
  testthat::expect_length(result, 4L)
  testthat::expect_type(result, "list")
  testthat::expect_named(result, 
                             c("key","perm_best_scores","obs_best_score","perm_pval"))
  testthat::expect_type(result$key, "list")
  testthat::expect_length(result$key, 11L)
  testthat::expect_named(result$key, 
                             c("FS", "input_score", "method", "custom_function", 
                               "custom_parameters", "alternative", "weight", "top_N",
                               "search_start", "search_method", "max_size"))
  testthat::expect_type(result$key$FS, "double")
  
  testthat::expect_equal(round(result$perm_best_scores[1:10],2), 
                         c("TN_641"=0.97,
                           "TN_738"=0.99,
                           "TN_667"=0.99,
                           "TN_469"=0.94,
                           "TN_485"=0.96,
                           "TN_474"=0.98,
                           "TN_318"=0.98,
                           "TN_252"=0.99,
                           "TN_510"=0.95,
                           "TN_550"=0.95))
  
  testthat::expect_equal(round(result$obs_best_score,2), c("TN_278"=0.98))
  
  # A smooth factor of 1
  c <- 1
  
  #Add a smoothing factor of 1 
  #This is just to not return a p-value of 0
  testthat::expect_equal(
    round((sum(result$perm_best_scores[1:10] > result$obs_best_score)+c)/(10+c),6), 
    c(0.363636)
  )
  
})

# ========================================================================= #
test_that("CaDrA returns expected result for Wilcoxon algorithm",{
  
  # Load pre-computed feature set
  data(sim_FS)
  
  # Load pre-computed input-score
  data(sim_Scores)
  
  set.seed(21)
  
  # wilcox_pval
  result <- CaDrA(
    FS = sim_FS, 
    input_score = sim_Scores, 
    method = "wilcox_pval", 
    weight = NULL, 
    alternative = "less", 
    top_N = 1,
    search_start = NULL, 
    search_method = "both", 
    max_size = 7, 
    n_perm = 10, 
    plot = FALSE, 
    smooth = TRUE, 
    obs_best_score = NULL,
    ncores = 1, 
    cache_path = NULL
  )
  
  
  testthat::expect_length(result, 4L)
  testthat::expect_type(result, "list")
  testthat::expect_named(result, 
            c("key","perm_best_scores","obs_best_score","perm_pval"))
  testthat::expect_type(result$key, "list")
  testthat::expect_length(result$key, 11L)
  testthat::expect_named(result$key, 
            c("FS", "input_score", "method", "custom_function", 
              "custom_parameters", "alternative", "weight", "top_N",
              "search_start", "search_method", "max_size"))
  testthat::expect_type(result$key$FS, "double")
  
  testthat::expect_equal(round(result$perm_best_scores[1:10],5), 
                         c("TN_674"=25.40974,
                           "TN_651"=29.96859,
                           "TN_490"=23.87704,
                           "TN_714"=25.97859,
                           "TN_424"=23.26229,
                           "TN_756"=30.61390,
                           "TN_845"=27.25412,
                           "TN_593"=24.18681,
                           "TN_296"=22.09454,
                           "TN_352"=23.90527))
  testthat::expect_equal(round(result$obs_best_score,5), c("TP_9"=27.75113))
  
  # A smooth factor of 1
  c <- 1
  
  #Add a smoothing factor of 1 
  #This is just to not return a p-value of 0
  testthat::expect_equal(
    round((sum(result$perm_best_scores[1:10] > result$obs_best_score)+c)/(10+c),6), 
    c(0.272727)
  )
  
  
  set.seed(21)
  
  # wilcox_score
  result <- CaDrA(
    FS = sim_FS, 
    input_score = sim_Scores, 
    method = "wilcox_score", 
    weight = NULL, 
    alternative = "less", 
    top_N = 1,
    search_start = NULL, 
    search_method = "both", 
    max_size = 7, 
    n_perm = 10, 
    plot = FALSE, 
    smooth = TRUE, 
    obs_best_score = NULL,
    ncores = 1, 
    cache_path = NULL
  )
  
  
  testthat::expect_length(result, 4L)
  testthat::expect_type(result, "list")
  testthat::expect_named(result, 
            c("key","perm_best_scores","obs_best_score","perm_pval"))
  testthat::expect_type(result$key, "list")
  testthat::expect_length(result$key, 11L)
  testthat::expect_named(result$key, 
            c("FS", "input_score", "method", "custom_function", 
              "custom_parameters", "alternative", "weight", "top_N",
              "search_start", "search_method", "max_size"))
  testthat::expect_type(result$key$FS, "double")
  
  testthat::expect_equal(result$perm_best_scores[1:10], 
                         c("TN_446"=2154,
                           "TN_441"=2121,
                           "TN_791"=2142,
                           "TN_691"=2132,
                           "TN_496"=2113,
                           "TN_774"=1999,
                           "TN_688"=2133,
                           "TN_247"=2158,
                           "TN_891"=2145,
                           "TN_691"=2011))
  testthat::expect_equal(result$obs_best_score, c("TN_277"=2150))
  
  # A smooth factor of 1
  c <- 1
  
  #Add a smoothing factor of 1 
  #This is just to not return a p-value of 0
  testthat::expect_equal(
    round((sum(result$perm_best_scores[1:10] > result$obs_best_score)+c)/(10+c),6), 
    c(0.272727)
  )
})


# ========================================================================= #
test_that("CaDrA returns expected result for Revealer algorithm",{
  
  # Load pre-computed feature set
  data(sim_FS)
  
  # Load pre-computed input-score
  data(sim_Scores)
  
  set.seed(21)
  
  # Revealer
  result <- CaDrA(
    FS = sim_FS, 
    input_score = sim_Scores, 
    method = "revealer", 
    weight = NULL, 
    alternative = "less", 
    top_N = 1,
    search_start = NULL, 
    search_method = "both", 
    max_size = 7, 
    n_perm = 10, 
    plot = FALSE, 
    smooth = TRUE, 
    obs_best_score = NULL,
    ncores = 1, 
    cache_path = NULL
  )
  
  
  testthat::expect_length(result, 4L)
  testthat::expect_type(result, "list")
  testthat::expect_named(result, 
            c("key","perm_best_scores","obs_best_score","perm_pval"))
  testthat::expect_type(result$key, "list")
  testthat::expect_length(result$key, 11L)
  testthat::expect_named(result$key, 
            c("FS", "input_score", "method", "custom_function", 
              "custom_parameters", "alternative", "weight", "top_N",
              "search_start", "search_method", "max_size"))
  testthat::expect_type(result$key$FS, "double")
  
  testthat::expect_equal(round(result$perm_best_scores[1:10],7), 
                         c("TN_607"=0.6187632,
                           "TN_651"=0.6875289,
                           "TN_490"=0.6527741,
                           "TN_482"=0.6647640,
                           "TN_424"=0.6744611,
                           "TN_888"=0.7160072,
                           "TN_845"=0.6694374,
                           "TN_128"=0.6329547,
                           "TN_432"=0.6196864,
                           "TN_282"=0.6366899))
  testthat::expect_equal(round(result$obs_best_score,5), c("TN_716"=0.68911))
  
  # A smooth factor of 1
  c <- 1
  
  #Add a smoothing factor of 1 
  #This is just to not return a p-value of 0
  testthat::expect_equal(
    round((sum(result$perm_best_scores[1:10] > result$obs_best_score)+c)/(10+c),6), 
    c(0.181818)
  )
  
 })





